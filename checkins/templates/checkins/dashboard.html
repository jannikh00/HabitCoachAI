{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- page heading -->
<h1 class="page-title">Dashboard</h1>
<!-- personalized greeting using the logged-in user's username -->
<p class="page-subtitle">Welcome, {{ request.user.username }}!</p>

<!-- (1) Current streak section -->
<!-- Displays how many consecutive days the user has checked in -->
<section aria-labelledby="streak" class="card">
  <h2 id="streak" class="card-title">Current Streak</h2>
  <p class="streak-summary">{{ streak.days }} days</p>
</section>

<!-- Displays prompt to do check-in for the day if not done yet -->
<p class="streak-message">
  {{ streak_message }}
</p>

<!-- (2) Mood and status trend over the past 7 days -->
<!-- Uses Django context variable 'trend', shown in a compact table -->
<section aria-labelledby="trend" class="card">
  <h2 id="trend" class="card-title">7-Day Trend (Mood/Status)</h2>

  <table class="table">
    <thead>
      <tr>
        <th>Date</th>
        <th>Mood</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for point in trend|slice:"::-1" %}
      <tr>
        <!-- Local calendar date -->
        <td>{{ point.date }}</td>

        <!-- Raw mood (1–5) or dash if missing -->
        <td>{{ point.mood|default:"–" }}</td>

        <!-- Status code (ok / warn / block / miss) -->
        <td>{{ point.status }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Reference: (Ref-C) background calculation of a 3-day moving average for mood tracking -->
  <p class="text-muted">
    <small>(Ref-C) 3-Day moving average for mood is calculated in the background for analytics.</small>
  </p>
</section>

<!-- Small Analytics Extension (Ref-C)
       This section adds a lightweight analytics summary to the dashboard.
       It uses data from the last 7 days (provided by the Django view) to show
       how many "risk days" occurred — defined as days with low mood (≤2)
       or a warning/block status. The approach is inspired by Ref-C (ISL),
       applying a simple and interpretable statistical summary. -->
<section aria-labelledby="analytics" class="card">
  <!-- Accessible heading label for screen readers -->
  <h2 id="analytics" class="card-title">Analytics</h2>

  <!-- Display the total number of "risk days" calculated in the backend -->
  <p>
    Risk days in the last 7&nbsp;days: <strong>{{ risk_count }}</strong>
  </p>

  <!-- Loop through the 7-day trend data and list each day that qualifies as "risky"
         (either status = warn/block or mood ≤ 2). -->
  <ul class="risk-day-list">
    {% for point in trend %}
    {% if point.status == "warn" or point.status == "block" or point.mood|default:3 <= 2 %} <!-- Show the date, status,
      and mood for each risk day -->
      <li class="risk-day-item">{{ point.date }} → {{ point.status }} (mood={{ point.mood|default:"–" }})</li>
      {% endif %}
      {% endfor %}
  </ul>

  <!-- Small note referencing Ref-C (ISL) to document the statistical rationale -->
  <p class="text-muted">
    <small>
      (Ref-C) Simple statistical evaluation – counts days with low mood or warning status.
    </small>
  </p>
</section>

<!-- (3) Tiny Habits suggestion section -->
<!-- Displays a personalized behavioral suggestion derived from Tiny Habits model -->
<section aria-labelledby="tiny" class="card">
  <h2 id="tiny" class="card-title">Tiny Habit Suggestion</h2>
  <p>{{ tiny_prompt }}</p>
  <!-- Reference: (Ref-A) Behavior model B=MAP (Motivation, Ability, Prompt) from Fogg (2020) [oai_citation:0‡Tiny Habits PDF.pdf](file-service://file-NuAXva6xhrtkyTnQcJKoan) -->
  <p class="text-muted"><small>(Ref-A) B=MAP, Starter-Step, Prompt-Design.</small></p>
</section>

<!-- (4) HRV tip section -->
<section aria-labelledby="hrv" class="card">
  <h2 id="hrv" class="card-title">HRV Note</h2>

  <!-- dynamic insight generated from latest RMSSD (backend) -->
  <p>{{ hrv_tip }}</p>

  <!-- static educational explanations for users -->
  <br>
  <h3 class="card-subtitle">What is HRV?</h3>
  <p>
    Heart Rate Variability (HRV) is the variation in time between your heartbeats.
    Higher HRV usually reflects better recovery and stronger parasympathetic activity
    (“rest and restore”), while lower HRV can reflect stress, fatigue or poor sleep.
  </p>

  <br>
  <h3 class="card-subtitle">What is RMSSD?</h3>
  <p>
    RMSSD (Root Mean Square of Successive Differences) is one of the most reliable
    short-term HRV metrics. It captures rapid changes in your nervous system and
    is widely used in sports science to monitor recovery and training load.
  </p>

  <br>
  <h3 class="card-subtitle">How can I measure HRV?</h3>
  <ul>
    <li>Use a wearable: Apple Watch, Garmin, Oura, WHOOP or a Polar chest strap</li>
    <li>Or use a smartphone app: HRV4Training, EliteHRV, ithlete, Welltory</li>
    <li>Measure in the morning, right after waking, while sitting or lying still</li>
    <li>One 60-second reading is usually enough for daily RMSSD</li>
  </ul>

  <!-- Reference to scientific source (Ref-B) -->
  <br>
  <p class="text-muted">
    <small>(Ref-B) Based on RMSSD interpretation from *Frontiers in Sports and Active Living* (Storniolo et al.,
      2025).</small>
  </p>
</section>

<!-- HRV-based readiness card -->
<section aria-labelledby="readiness" class="card readiness-status">
  <!-- heading to describe the HRV readiness classification -->
  <h2 id="readiness" class="card-title">Today’s Readiness</h2>

  <!-- show the coarse readiness label, e.g., "High readiness" / "Moderate readiness" / "Low readiness" -->
  <p class="readiness-label">
    Status:
    <strong>{{ readiness.label }}</strong>
  </p>

  <!-- show the explanatory description from the backend helper -->
  <p class="readiness-description">
    {{ readiness.description }}
  </p>

  <!-- Tiny Habits–aligned microcopy (Ref-A):
       encourage small wins and appropriate scaling based on readiness -->
  <p class="text-muted">
    Use this as a guide to size your next tiny habit:
    when readiness is lower, shrink the habit and celebrate completing it.
  </p>
</section>

<!-- (5) Adherence Forecast Section -->
<!-- Displays model-predicted likelihood of next habit completion -->
<section aria-labelledby="forecast" class="card">
  <h2 id="forecast" class="card-title">Today’s Adherence Forecast</h2>

  <!-- Display computed completion probability -->
  <p class="forecast-value">{{ completion_prob }}% likelihood you’ll complete your next habit.</p>

  <!-- Explanation helping users understand what the forecast means -->
  <p class="forecast-explanation"> {{ completion_explanation }} </p>

  <!-- Explanatory note connecting behavioral and physiological data -->
  <p class="forecast-caption text-muted">
    Based on your last 7 days of check-ins (behavioral consistency, reflecting Tiny Habits’
    idea of successive wins) and your most recent HRV reading (physiological readiness).
  </p>
</section>

{% endblock %}